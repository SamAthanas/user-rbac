<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RBAC Configuration</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 15px;
            background-color: #f5f5f5;
            color: #333;
            font-size: 14px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: #1976d2;
            color: white;
            padding: 15px 20px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 20px;
        }
        .content {
            padding: 20px;
        }
        .user-section {
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            overflow: hidden;
        }
        .user-header {
            background: #f8f9fa;
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .user-header:hover {
            background: #e9ecef;
        }
        .user-header .expand-icon {
            font-size: 18px;
            transition: transform 0.2s;
        }
        .user-header.collapsed .expand-icon {
            transform: rotate(-90deg);
        }
        .user-content {
            padding: 15px;
            display: block;
        }
        .user-content.collapsed {
            display: none;
        }
        .config-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .config-group {
            flex: 1;
            min-width: 0;
        }
        .config-group h3 {
            margin: 0 0 10px 0;
            color: #1976d2;
            font-size: 14px;
            font-weight: 600;
        }
        .multiselect-container {
            position: relative;
            width: 100%;
        }
        .multiselect-dropdown {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-size: 13px;
            min-height: 36px;
            display: flex;
            align-items: center;
        }
        .multiselect-dropdown:focus {
            outline: none;
            border-color: #1976d2;
        }
        .multiselect-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e0e0e0;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 150px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        .multiselect-option {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
        }
        .multiselect-option:hover {
            background: #f5f5f5;
        }
        .multiselect-option.selected {
            background: #e3f2fd;
            color: #1976d2;
        }
        .multiselect-option input[type="checkbox"] {
            margin-right: 8px;
        }
        .selected-items {
            margin-top: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }
        .selected-item {
            background: #1976d2;
            color: white;
            padding: 3px 6px;
            border-radius: 3px;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .selected-item .remove {
            cursor: pointer;
            font-weight: bold;
        }
        .save-button {
            background: #4caf50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .save-button:hover {
            background: #45a049;
        }
        .save-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 8px 12px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 13px;
        }
        .success {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 8px 12px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 13px;
        }
        .service-hint {
            font-size: 11px;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>RBAC Access Control Configuration</h1>
        </div>
        <div class="content">
            <div id="loading" class="loading">Loading configuration...</div>
            <div id="error" class="error" style="display: none;"></div>
            <div id="success" class="success" style="display: none;"></div>
            <div id="config-content" style="display: none;">
                <!-- Configuration content will be populated here -->
            </div>
        </div>
        <button id="global-save-button" class="save-button" style="display: none;">
            Save Config
        </button>
    </div>

    <script>
        class RBACConfig {
            constructor() {
                this.config = null;
                this.users = [];
                this.domains = [];
                this.entities = [];
                this.services = [];
                this.init();
            }

            async init() {
                try {
                    await this.loadData();
                    this.render();
                } catch (error) {
                    this.showError('Failed to load configuration: ' + error.message);
                }
            }

            async getHAAuth() {
                // Try to get authentication from Home Assistant
                try {
                    // Check if we're running in Home Assistant context
                    if (window.hass) {
                        return {
                            access_token: window.hass.auth.data.access_token
                        };
                    }
                    
                    // Try to get from localStorage (if available)
                    const auth = localStorage.getItem('hassTokens');
                    if (auth) {
                        const tokens = JSON.parse(auth);
                        return {
                            access_token: tokens.access_token
                        };
                    }
                    
                    // Try to get from sessionStorage
                    const sessionAuth = sessionStorage.getItem('hassTokens');
                    if (sessionAuth) {
                        const tokens = JSON.parse(sessionAuth);
                        return {
                            access_token: tokens.access_token
                        };
                    }
                    
                    return null;
                } catch (error) {
                    console.error('Error getting HA auth:', error);
                    return null;
                }
            }

            async loadData() {
                // Get Home Assistant authentication token
                const auth = await this.getHAAuth();
                if (!auth) {
                    throw new Error('Not authenticated with Home Assistant');
                }

                console.log('Loading RBAC data with auth token:', auth.access_token ? 'present' : 'missing');

                // Load users, domains, entities, and services
                const [usersResponse, domainsResponse, entitiesResponse, servicesResponse] = await Promise.all([
                    fetch('/api/rbac/users', {
                        headers: {
                            'Authorization': `Bearer ${auth.access_token}`,
                            'Content-Type': 'application/json'
                        }
                    }),
                    fetch('/api/rbac/domains', {
                        headers: {
                            'Authorization': `Bearer ${auth.access_token}`,
                            'Content-Type': 'application/json'
                        }
                    }),
                    fetch('/api/rbac/entities', {
                        headers: {
                            'Authorization': `Bearer ${auth.access_token}`,
                            'Content-Type': 'application/json'
                        }
                    }),
                    fetch('/api/rbac/services', {
                        headers: {
                            'Authorization': `Bearer ${auth.access_token}`,
                            'Content-Type': 'application/json'
                        }
                    })
                ]);

                console.log('API responses:', {
                    users: usersResponse.status,
                    domains: domainsResponse.status,
                    entities: entitiesResponse.status,
                    services: servicesResponse.status
                });

                if (!usersResponse.ok || !domainsResponse.ok || !entitiesResponse.ok || !servicesResponse.ok) {
                    const errors = [];
                    if (!usersResponse.ok) errors.push(`Users: ${usersResponse.status} ${usersResponse.statusText}`);
                    if (!domainsResponse.ok) errors.push(`Domains: ${domainsResponse.status} ${domainsResponse.statusText}`);
                    if (!entitiesResponse.ok) errors.push(`Entities: ${entitiesResponse.status} ${entitiesResponse.statusText}`);
                    if (!servicesResponse.ok) errors.push(`Services: ${servicesResponse.status} ${servicesResponse.statusText}`);
                    throw new Error('Failed to load data from API: ' + errors.join(', '));
                }

                this.users = await usersResponse.json();
                this.domains = await domainsResponse.json();
                this.entities = await entitiesResponse.json();
                this.services = await servicesResponse.json();

                console.log('Loaded data:', {
                    users: this.users.length,
                    domains: this.domains.length,
                    entities: this.entities.length,
                    services: this.services.length
                });

                // Load current configuration
                const configResponse = await fetch('/api/rbac/config', {
                    headers: {
                        'Authorization': `Bearer ${auth.access_token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('Config response:', configResponse.status);
                
                if (configResponse.ok) {
                    this.config = await configResponse.json();
                    console.log('Loaded config:', this.config);
                } else {
                    console.warn('Failed to load config:', configResponse.status, configResponse.statusText);
                    this.config = {};
                }
            }

            render() {
                const content = document.getElementById('config-content');
                const loading = document.getElementById('loading');
                const saveButton = document.getElementById('global-save-button');
                
                loading.style.display = 'none';
                content.style.display = 'block';
                saveButton.style.display = 'block';

                console.log('Rendering with config:', this.config);
                console.log('Available users:', this.users);
                console.log('Available domains:', this.domains);
                console.log('Available entities:', this.entities);
                console.log('Available services:', this.services);

                let html = '';

                // Default settings section
                html += this.renderUserSection('default', 'Default Settings', true);

                // User sections
                this.users.forEach(user => {
                    html += this.renderUserSection(user.id, user.name, false);
                });

                content.innerHTML = html;
                this.attachEventListeners();
            }

            renderUserSection(userId, userName, isDefault) {
                const userConfig = this.config?.users?.[userId] || {};
                const restrictions = userConfig.restrictions || {};
                const domainRestrictions = restrictions.domains || {};
                const entityRestrictions = restrictions.entities || {};
                const serviceRestrictions = restrictions.services || {};

                console.log(`Rendering user section for ${userId}:`, {
                    userConfig,
                    restrictions,
                    domainRestrictions,
                    entityRestrictions,
                    serviceRestrictions
                });

                return `
                    <div class="user-section">
                        <div class="user-header" data-user="${userId}">
                            <span>${isDefault ? 'ðŸ”§ ' : 'ðŸ‘¤ '}${userName}</span>
                            <span class="expand-icon">â–¼</span>
                        </div>
                        <div class="user-content" data-user="${userId}">
                            <div class="config-row">
                                <div class="config-group">
                                    <h3>Domain Restrictions</h3>
                                    <div class="multiselect-container">
                                        <div class="multiselect-dropdown" data-type="domains" data-user="${userId}">
                                            Select domains to restrict...
                                        </div>
                                        <div class="multiselect-options" data-type="domains" data-user="${userId}">
                                            ${this.domains.map(domain => `
                                                <div class="multiselect-option ${domainRestrictions[domain] ? 'selected' : ''}" data-value="${domain}">
                                                    <input type="checkbox" ${domainRestrictions[domain] ? 'checked' : ''}>
                                                    ${domain}
                                                </div>
                                            `).join('')}
                                        </div>
                                        <div class="selected-items" data-type="domains" data-user="${userId}">
                                            ${Object.keys(domainRestrictions).map(domain => `
                                                <div class="selected-item">
                                                    ${domain}
                                                    <span class="remove" data-value="${domain}">Ã—</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="config-group">
                                    <h3>Domain Services</h3>
                                    <div class="multiselect-container">
                                        <div class="multiselect-dropdown" data-type="domain-services" data-user="${userId}">
                                            Select services for domains...
                                        </div>
                                        <div class="multiselect-options" data-type="domain-services" data-user="${userId}">
                                            <!-- Will be populated dynamically based on selected domains -->
                                        </div>
                                        <div class="selected-items" data-type="domain-services" data-user="${userId}">
                                            ${Object.keys(serviceRestrictions).filter(s => s.includes('.')).map(service => `
                                                <div class="selected-item">
                                                    ${service}
                                                    <span class="remove" data-value="${service}">Ã—</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                    <div class="service-hint">Services will be filtered based on selected domains</div>
                                </div>
                            </div>

                            <div class="config-row">
                                <div class="config-group">
                                    <h3>Entity Restrictions</h3>
                                    <div class="multiselect-container">
                                        <div class="multiselect-dropdown" data-type="entities" data-user="${userId}">
                                            Select entities to restrict...
                                        </div>
                                        <div class="multiselect-options" data-type="entities" data-user="${userId}">
                                            ${this.entities.map(entity => `
                                                <div class="multiselect-option ${entityRestrictions[entity] ? 'selected' : ''}" data-value="${entity}">
                                                    <input type="checkbox" ${entityRestrictions[entity] ? 'checked' : ''}>
                                                    ${entity}
                                                </div>
                                            `).join('')}
                                        </div>
                                        <div class="selected-items" data-type="entities" data-user="${userId}">
                                            ${Object.keys(entityRestrictions).map(entity => `
                                                <div class="selected-item">
                                                    ${entity}
                                                    <span class="remove" data-value="${entity}">Ã—</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="config-group">
                                    <h3>Entity Services</h3>
                                    <div class="multiselect-container">
                                        <div class="multiselect-dropdown" data-type="entity-services" data-user="${userId}">
                                            Select services for entities...
                                        </div>
                                        <div class="multiselect-options" data-type="entity-services" data-user="${userId}">
                                            <!-- Will be populated dynamically based on selected entities -->
                                        </div>
                                        <div class="selected-items" data-type="entity-services" data-user="${userId}">
                                            ${Object.keys(serviceRestrictions).filter(s => s.includes('.')).map(service => `
                                                <div class="selected-item">
                                                    ${service}
                                                    <span class="remove" data-value="${service}">Ã—</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                    <div class="service-hint">Services will be filtered based on selected entities</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            attachEventListeners() {
                // Collapsible sections
                document.querySelectorAll('.user-header').forEach(header => {
                    header.addEventListener('click', (e) => {
                        const userId = header.dataset.user;
                        const content = document.querySelector(`.user-content[data-user="${userId}"]`);
                        const icon = header.querySelector('.expand-icon');
                        
                        if (content.classList.contains('collapsed')) {
                            content.classList.remove('collapsed');
                            header.classList.remove('collapsed');
                        } else {
                            content.classList.add('collapsed');
                            header.classList.add('collapsed');
                        }
                    });
                });

                // Multiselect dropdown functionality
                document.querySelectorAll('.multiselect-dropdown').forEach(dropdown => {
                    dropdown.addEventListener('click', (e) => {
                        const options = dropdown.nextElementSibling;
                        options.style.display = options.style.display === 'none' ? 'block' : 'none';
                    });
                });

                // Option selection
                document.querySelectorAll('.multiselect-option').forEach(option => {
                    option.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const checkbox = option.querySelector('input[type="checkbox"]');
                        checkbox.checked = !checkbox.checked;
                        this.updateSelection(option);
                    });

                    option.querySelector('input[type="checkbox"]').addEventListener('change', (e) => {
                        e.stopPropagation();
                        this.updateSelection(option);
                    });
                });

                // Remove selected items
                document.querySelectorAll('.selected-item .remove').forEach(removeBtn => {
                    removeBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const value = removeBtn.dataset.value;
                        const userId = removeBtn.closest('.selected-items').dataset.user;
                        const type = removeBtn.closest('.selected-items').dataset.type;
                        this.removeSelection(userId, type, value);
                    });
                });

                // Global save button
                document.getElementById('global-save-button').addEventListener('click', (e) => {
                    this.saveAllConfigs();
                });

                // Close dropdowns when clicking outside
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.multiselect-container')) {
                        document.querySelectorAll('.multiselect-options').forEach(options => {
                            options.style.display = 'none';
                        });
                    }
                });

                // Update service options when domains/entities change
                this.updateServiceOptions();
            }

            updateServiceOptions() {
                // Update domain services based on selected domains
                document.querySelectorAll('[data-type="domains"]').forEach(domainContainer => {
                    const userId = domainContainer.dataset.user;
                    const selectedDomains = this.getSelectedValues(userId, 'domains');
                    const serviceContainer = document.querySelector(`[data-type="domain-services"][data-user="${userId}"]`);
                    
                    if (serviceContainer) {
                        const availableServices = this.services.filter(service => {
                            const domain = service.split('.')[0];
                            return selectedDomains.includes(domain);
                        });
                        
                        serviceContainer.innerHTML = availableServices.map(service => `
                            <div class="multiselect-option" data-value="${service}">
                                <input type="checkbox">
                                ${service}
                            </div>
                        `).join('');
                        
                        // Reattach event listeners
                        serviceContainer.querySelectorAll('.multiselect-option').forEach(option => {
                            option.addEventListener('click', (e) => {
                                e.stopPropagation();
                                const checkbox = option.querySelector('input[type="checkbox"]');
                                checkbox.checked = !checkbox.checked;
                                this.updateSelection(option);
                            });
                        });
                    }
                });

                // Update entity services based on selected entities
                document.querySelectorAll('[data-type="entities"]').forEach(entityContainer => {
                    const userId = entityContainer.dataset.user;
                    const selectedEntities = this.getSelectedValues(userId, 'entities');
                    const serviceContainer = document.querySelector(`[data-type="entity-services"][data-user="${userId}"]`);
                    
                    if (serviceContainer) {
                        const availableServices = this.services.filter(service => {
                            const domain = service.split('.')[0];
                            return selectedEntities.some(entity => entity.startsWith(domain + '.'));
                        });
                        
                        serviceContainer.innerHTML = availableServices.map(service => `
                            <div class="multiselect-option" data-value="${service}">
                                <input type="checkbox">
                                ${service}
                            </div>
                        `).join('');
                        
                        // Reattach event listeners
                        serviceContainer.querySelectorAll('.multiselect-option').forEach(option => {
                            option.addEventListener('click', (e) => {
                                e.stopPropagation();
                                const checkbox = option.querySelector('input[type="checkbox"]');
                                checkbox.checked = !checkbox.checked;
                                this.updateSelection(option);
                            });
                        });
                    }
                });
            }

            getSelectedValues(userId, type) {
                const container = document.querySelector(`[data-type="${type}"][data-user="${userId}"]`);
                if (!container) return [];
                
                return Array.from(container.querySelectorAll('.multiselect-option.selected')).map(option => option.dataset.value);
            }

            updateSelection(option) {
                const checkbox = option.querySelector('input[type="checkbox"]');
                const value = option.dataset.value;
                const userId = option.closest('.multiselect-options').dataset.user;
                const type = option.closest('.multiselect-options').dataset.type;
                const selectedItems = document.querySelector(`[data-type="${type}"][data-user="${userId}"]`);

                if (checkbox.checked) {
                    option.classList.add('selected');
                    if (!selectedItems.querySelector(`[data-value="${value}"]`)) {
                        selectedItems.innerHTML += `
                            <div class="selected-item">
                                ${value}
                                <span class="remove" data-value="${value}">Ã—</span>
                            </div>
                        `;
                        // Reattach event listener for the new remove button
                        selectedItems.querySelector(`[data-value="${value}"] .remove`).addEventListener('click', (e) => {
                            e.stopPropagation();
                            this.removeSelection(userId, type, value);
                        });
                    }
                } else {
                    option.classList.remove('selected');
                    const item = selectedItems.querySelector(`[data-value="${value}"]`);
                    if (item) {
                        item.remove();
                    }
                }

                // Update service options when domains/entities change
                if (type === 'domains' || type === 'entities') {
                    this.updateServiceOptions();
                }
            }

            removeSelection(userId, type, value) {
                // Update checkbox
                const option = document.querySelector(`[data-type="${type}"][data-user="${userId}"] .multiselect-option[data-value="${value}"]`);
                if (option) {
                    const checkbox = option.querySelector('input[type="checkbox"]');
                    checkbox.checked = false;
                    option.classList.remove('selected');
                }

                // Remove from selected items
                const item = document.querySelector(`[data-type="${type}"][data-user="${userId}"] .selected-item[data-value="${value}"]`);
                if (item) {
                    item.remove();
                }

                // Update service options when domains/entities change
                if (type === 'domains' || type === 'entities') {
                    this.updateServiceOptions();
                }
            }

            async saveAllConfigs() {
                const button = document.getElementById('global-save-button');
                button.disabled = true;
                button.textContent = 'Saving...';

                try {
                    const auth = await this.getHAAuth();
                    if (!auth) {
                        throw new Error('Not authenticated with Home Assistant');
                    }

                    // Save default configuration
                    const defaultConfig = this.getUserConfig('default');
                    console.log('Saving default config:', defaultConfig);
                    
                    const defaultResponse = await fetch('/api/rbac/config', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${auth.access_token}`,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            userId: 'default',
                            config: defaultConfig
                        })
                    });

                    if (!defaultResponse.ok) {
                        throw new Error('Failed to save default configuration');
                    }

                    // Save user configurations
                    const userPromises = this.users.map(async (user) => {
                        const userConfig = this.getUserConfig(user.id);
                        console.log(`Saving config for user ${user.id}:`, userConfig);
                        
                        return fetch('/api/rbac/config', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${auth.access_token}`,
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                userId: user.id,
                                config: userConfig
                            })
                        });
                    });

                    const userResponses = await Promise.all(userPromises);
                    
                    for (const response of userResponses) {
                        if (!response.ok) {
                            throw new Error('Failed to save user configuration');
                        }
                    }

                    this.showSuccess('All configurations saved successfully!');
                } catch (error) {
                    this.showError('Failed to save configuration: ' + error.message);
                } finally {
                    button.disabled = false;
                    button.textContent = 'Save Config';
                }
            }

            async saveUserConfig(userId) {
                const button = document.querySelector(`[data-user="${userId}"]`);
                button.disabled = true;
                button.textContent = 'Saving...';

                try {
                    const auth = await this.getHAAuth();
                    if (!auth) {
                        throw new Error('Not authenticated with Home Assistant');
                    }

                    const config = this.getUserConfig(userId);
                    const response = await fetch('/api/rbac/config', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${auth.access_token}`,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            userId: userId,
                            config: config
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Failed to save configuration');
                    }

                    this.showSuccess(`Configuration saved successfully for ${userId === 'default' ? 'Default Settings' : 'User'}`);
                } catch (error) {
                    this.showError('Failed to save configuration: ' + error.message);
                } finally {
                    button.disabled = false;
                    button.textContent = `Save ${userId === 'default' ? 'Default Settings' : 'User'} Configuration`;
                }
            }

            getUserConfig(userId) {
                console.log(`Getting config for user: ${userId}`);
                
                const config = {
                    restrictions: {
                        domains: {},
                        entities: {},
                        services: {}
                    }
                };

                // Get domain restrictions
                const domainItems = document.querySelectorAll(`[data-type="domains"][data-user="${userId}"] .selected-item`);
                console.log(`Found ${domainItems.length} domain items for ${userId}`);
                domainItems.forEach(item => {
                    const domain = item.textContent.trim().replace('Ã—', '').trim();
                    config.restrictions.domains[domain] = { hide: true };
                    console.log(`Added domain restriction: ${domain}`);
                });

                // Get entity restrictions
                const entityItems = document.querySelectorAll(`[data-type="entities"][data-user="${userId}"] .selected-item`);
                console.log(`Found ${entityItems.length} entity items for ${userId}`);
                entityItems.forEach(item => {
                    const entity = item.textContent.trim().replace('Ã—', '').trim();
                    config.restrictions.entities[entity] = { hide: true };
                    console.log(`Added entity restriction: ${entity}`);
                });

                // Get service restrictions
                const serviceItems = document.querySelectorAll(`[data-type="domain-services"][data-user="${userId}"] .selected-item, [data-type="entity-services"][data-user="${userId}"] .selected-item`);
                console.log(`Found ${serviceItems.length} service items for ${userId}`);
                serviceItems.forEach(item => {
                    const service = item.textContent.trim().replace('Ã—', '').trim();
                    config.restrictions.services[service] = { hide: true };
                    console.log(`Added service restriction: ${service}`);
                });

                console.log(`Final config for ${userId}:`, config);
                return config;
            }

            showError(message) {
                const errorDiv = document.getElementById('error');
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 5000);
            }

            showSuccess(message) {
                const successDiv = document.getElementById('success');
                successDiv.textContent = message;
                successDiv.style.display = 'block';
                setTimeout(() => {
                    successDiv.style.display = 'none';
                }, 3000);
            }
        }

        // Initialize the configuration page
        new RBACConfig();
    </script>
</body>
</html>